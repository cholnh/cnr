services:
  postgres:
    image: postgres:17
    container_name: cnr-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: cnr-local
      POSTGRES_PASSWORD: cnr-local
    volumes:
      - cnr-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: cnr-redis
    ports:
      - "6379:6379"
    volumes:
      - cnr-redis-data:/data
    restart: unless-stopped

  app:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: cnr-app
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: jdbc:postgresql://cnr-postgres:5432/postgres
      SPRING_DATA_REDIS_HOST: cnr-redis
      JAVA_OPTS: "-Xmx8g -Xms8g"
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: cnr-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app
    restart: unless-stopped

  actions-runner:
    image: myoung34/github-runner:latest
    container_name: cnr-actions-runner
    environment:
      REPO_URL: ${GITHUB_URL}
      ACCESS_TOKEN: ${GITHUB_TOKEN}
      RUNNER_NAME: cnr-home-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data:/home/runner
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
      - app

volumes:
  cnr-postgres-data:
  cnr-redis-data:
